name: ğŸ‰ Release Pipeline

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.2.3)'
        required: true

env:
  NODE_VERSION: '22.x'

jobs:
  create-release:
    name: ğŸ‰ Create Release
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run full test suite
        run: |
          npm run test:unit:fast
          npm run test:integration:app

      - name: ğŸ“ Generate changelog
        id: changelog
        run: |
          echo "## ğŸš€ What's New" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          git log --pretty=format:"- %s (%h)" $(git describe --tags --abbrev=0 2>/dev/null || echo "")..HEAD >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## ğŸ”§ Technical Details" >> CHANGELOG.md
          echo "- Node.js version: ${{ env.NODE_VERSION }}" >> CHANGELOG.md
          echo "- Tests passing: âœ…" >> CHANGELOG.md
          echo "- Docker image: Available" >> CHANGELOG.md

      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ³ Tag Docker images for release
        run: |
          echo "ğŸ³ Tagging Docker images for release ${{ github.ref_name }}"
          # Implementar tag das imagens Docker
          echo "âœ… Docker images tagged"

      - name: ğŸ“¢ Notify release
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#releases'
          username: 'Release Bot'
          title: 'ğŸ‰ New Release Available'
          text: |
            ğŸš€ Authentication Service ${{ github.ref_name }} has been released!
            ğŸ“¦ Tag: ${{ github.ref_name }}
            ğŸ‘¤ Released by: ${{ github.actor }}
            ğŸ”— Release notes: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
